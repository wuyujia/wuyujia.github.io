---
title: å¦‚ä½•å¯¼å‡ºä¸Šç™¾ä¸‡æ•°æ®?
index: true
---

## åŸç†è§£æ

### è¿™ä¸ªåœºæ™¯æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ
1. ä¸šåŠ¡è¦æ±‚è¿›è¡Œæ•°æ®å¯¼å‡ºï¼Œåªä¸è¿‡æ•°æ®é‡ç‰¹åˆ«å¤§ï¼›
2. æ•°æ®åˆ†æå¸ˆéœ€è¦è¿™ä¹ˆå¤šæ•°æ®è¿›è¡Œåˆ†æï¼›
æ— è®ºæ˜¯å“ªç§ï¼Œéƒ½éœ€è¦æŠ€æœ¯å¸®å¿™è¿›è¡Œæ•°æ®å¯¼å‡ºï¼Œä½†æ˜¯ä¸€ä¸‹å­æŸ¥è¯¢è¿™ä¹ˆæ•°æ®å ç”¨å†…å­˜è‚¯å®šç‰¹åˆ«å¤§ã€‚å¦‚æœç›´æ¥ä½¿ç”¨ORMæ¡†æ¶è¿›è¡ŒæŸ¥è¯¢ï¼Œå†…å­˜æ€•æ˜¯ä¼šç›´æ¥ç‚¸æ‰ï¼ˆå°¤å…¶æ˜¯åœ¨å¯èƒ½å­˜åœ¨å¹¶å‘çš„åœºæ™¯ä¸‹ï¼‰

é‡åˆ°ç±»ä¼¼é—®é¢˜ï¼Œå…ˆé—®ä¸€é—®ï¼Œä¸šåŠ¡åœºæ™¯æ˜¯å¦åˆç†ï¼Ÿä¸€èˆ¬excelä¹Ÿä¸èƒ½æ‰“å¼€è¿™ä¹ˆå¤§æ•°æ®é‡çš„æ–‡ä»¶ï¼Œæ®æˆ‘æ‰€çŸ¥ office 2007 ç‰ˆä¹Ÿåªèƒ½å¤Ÿæ‰“å¼€104ä¸‡è¡Œæ•°æ®ï¼Œ03ç‰ˆåªèƒ½æ‰“å¼€65534è¡Œæ•°æ®ã€‚

### ç°æœ‰ORMåœ¨è·å–å¤§é‡æ•°æ®å­˜åœ¨çš„é—®é¢˜
æˆ‘ç»å¸¸ä½¿ç”¨çš„ORMæ¡†æ¶æ˜¯`mybatis`ï¼Œä¼˜ç‚¹æ˜¯ï¼šè½»é‡ã€å¿«é€Ÿé›†æˆã€SQLå¯å®šåˆ¶åŒ–ç¨‹åº¦é«˜ï¼Œå°¤å…¶æ˜¯åœ¨å¼•å…¥`mybatis-plus`ä¹‹åï¼Œå•è¡¨çš„å¢åˆ æ”¹æŸ¥ä¹Ÿèƒ½å¤Ÿé€šè¿‡æ— SQLæ¨¡å¼æ‰§è¡Œï¼ŒåŒæ—¶æä¾›æœ‰ä»£ç ç”Ÿæˆå·¥å…·ï¼Œååˆ†æ–¹ä¾¿ã€‚

MyBtaisåº•å±‚å®ç°æ˜¯é€šè¿‡JDBCæ‰“å¼€è¿æ¥ï¼Œæ‰§è¡Œè¯­å¥ï¼Œè·å–ç»“æœï¼Œå¯¹ç»“æœè¿›è¡Œæ˜ å°„ï¼Œç›´è‡³å°†æ‰€æœ‰ç»“æœå¤„ç†ä¹‹åå†è¿”å›ç»™è°ƒç”¨è€…ä½¿ç”¨ï¼Œæ•°æ®å°‘æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯é‡åˆ°ä¸‡çº§ä»¥ä¸Šæ•°æ®ï¼Œè¿™å°±æœ‰æ¯”è¾ƒå¤§çš„é—®é¢˜äº†ï¼Œæœ€åŸºæœ¬çš„å°±æ˜¯å†…å­˜å ç”¨ã€‚

åœ¨é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œæ ¹æœ¬ä¸å¯èƒ½æ‰›ä½è¿™ä¹ˆå¤§é‡çš„æ•°æ®å¯¼å‡ºï¼Œæˆ–è€…è®¡ç®—ã€‚

### è§£å†³åŠæ³•
é‡‡ç”¨`æµå¼æŸ¥è¯¢`ï¼Œæˆ–è€…`æ¸¸æ ‡æŸ¥è¯¢`ï¼Œå¦‚æœä½¿ç”¨å¤§é‡æ•°æ®è¡Œçš„ResultSetï¼Œå¹¶ä¸”æ— æ³•åœ¨JVMä¸­ä¸ºå…¶åˆ†é…æ‰€éœ€è¦çš„å†…å­˜ç©ºé—´ï¼Œåˆ™å¯ä»¥å‘Šè¯‰é©±åŠ¨ç¨‹åºä»ç»“æœæµä¸­è¿”å›ä¸€è¡Œï¼Œå°†è¿™ä¸€è¡Œæ•°æ®å†™å‡ºåˆ°æ–‡ä»¶ä¸­ï¼Œå†™å‡ºåˆ°æµä¸­ä»¥åï¼Œå†è®¿é—®ä¸‹ä¸€è¡Œã€‚
::: warning æ³¨æ„
æµå¼æŸ¥è¯¢æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼šå¿…é¡»å…ˆè¯»å–ï¼ˆæˆ–å…³é—­ï¼‰ç»“æœé›†ä¸­çš„æ‰€æœ‰è¡Œï¼Œç„¶åæ‰èƒ½å¯¹è¿æ¥å‘å‡ºå…¶å®ƒæŸ¥è¯¢ï¼Œå¦åˆ™å°†å¼•å‘å¼‚å¸¸

ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸è¦å†ç»“æœé›†ä¸­ä½¿ç”¨ç›¸åŒçš„è¿æ¥å¹²åˆ«çš„äº‹å„¿ã€‚
:::

ä½¿ç”¨æµå¼æŸ¥è¯¢ï¼Œåˆ™è¦ä¿æŒå¯¹ç»“æœé›†çš„è¯­å¥æ‰€å¼•ç”¨çš„è¡¨çš„å¹¶å‘è®¿é—®ï¼Œå› ä¸ºæŸ¥è¯¢ä¼šå ç”¨è¿æ¥ï¼Œæ‰€ä»¥å¿…é¡»å°½å¿«å¤„ç†ã€‚

## ç¯å¢ƒæ¨¡æ‹Ÿè¯´æ˜
æ­å»ºä¸€ä¸ªæ–°çš„SpringBoot + Mybatisé¡¹ç›®ï¼Œåœ¨æ•°æ®åº“ä¸­åˆ›å»º500Wæ•°æ®ï¼Œé€šè¿‡æ§åˆ¶JVMå†…å­˜å¤§å°ï¼Œæ¥æ¨¡æ‹Ÿ`æ™®é€šæŸ¥è¯¢`å’Œ`æµå¼æŸ¥è¯¢`ä¸‹è½½æ–‡ä»¶ï¼Œæ–‡ä»¶ä¸‹è½½æ ¼å¼csv

### æ•°æ®å‡†å¤‡
::: tabs

@tab:active Dockerå¯åŠ¨MySQL
``` bash
docker pull mysql:5.7

docker run -d --name mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=root mysql:5.7
```

@tab MySQLåˆ›å»ºDBå’Œè¡¨
``` sql
create database stream_db charset utf8;

CREATE TABLE `t_stream` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®',
  `name` varchar(255) DEFAULT NULL COMMENT 'åç§°',
  `value` varchar(255) DEFAULT NULL COMMENT 'å€¼',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`)
);
```

@tab å­˜å‚¨è¿‡ç¨‹
æ‰¹é‡æ’å…¥æ•°æ®ç¥å™¨ğŸ˜„
``` sql
TRUNCATE TABLE t_stream;

delimiter ;;
CREATE PROCEDURE batch_insert(IN size INT)
BEGIN
	DECLARE i INT;
	SET i = 1;
	START TRANSACTION;
	WHILE(i <= size)DO
		INSERT INTO t_stream (id, `name`, `value`) VALUES (i, CONCAT('åç§°: ', i), size + i);
		SET i=i+1;
	END WHILE;
	COMMIT;
END
;;
delimiter ;

CALL batch_insert(5000000);

DROP PROCEDURE IF EXISTS batch_insert;
```

:::

## æ¡†æ¶æ­å»º
::: tabs

@tab:active pom.xml
å…¨éƒ¨è´´å‡ºæ¥å¤ªå¤§äº†ï¼Œæ²¡å¿…è¦ï¼Œè´´å‡ºå…³é”®çš„å°±è¡Œ
``` xml
...
<parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>2.4.5</version>
    <relativePath/> <!-- lookup parent from repository -->
</parent>
...

<properties>
    <java.version>8</java.version>
</properties>
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
        <version>8.0.28</version>
        <scope>runtime</scope>
    </dependency>
    <dependency>
        <groupId>com.baomidou</groupId>
        <artifactId>mybatis-plus-boot-starter</artifactId>
        <version>3.5.2</version>
    </dependency>
</dependencies>
```

@tab application.properties
``` properties
spring.datasource.url=jdbc:mysql://localhost:3306/stream_db?characterEncoding=utf8&useSSL=false
spring.datasource.username=root
spring.datasource.password=root
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
```

@tab StreamController.java
``` java
package com.example.exportbitdata;

import lombok.SneakyThrows;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpHeaders;
import org.springframework.stereotype.Controller;
import org.springframework.util.StopWatch;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;

import javax.servlet.ServletOutputStream;
import javax.servlet.http.HttpServletResponse;
import java.io.BufferedWriter;
import java.io.IOException;
import java.io.OutputStreamWriter;
import java.util.List;
import java.util.Optional;

@Controller
public class StreamController {

    @Autowired
    private StreamMapper streamMapper;
    private static final char CONJ = ',';

    @RequestMapping("/normal")
    public void normal(@RequestParam(required = false) Integer size, HttpServletResponse response) throws IOException {
        StopWatch sw = new StopWatch("Normal Timer");
        sw.start("setting");
        downloadSetting(response);
        ServletOutputStream out = response.getOutputStream();
        BufferedWriter writer = new BufferedWriter(new OutputStreamWriter(out, "GB2312"), 1024);
        sw.stop();
        try {
            sw.start("Query Data");
            List<StreamDTO> streamDTOS = streamMapper.normalSelectLimit(Optional.ofNullable(size).orElse(50));
            sw.stop();
            sw.start("Write Data");
            for (StreamDTO streamDTO : streamDTOS) {
                writeRow(streamDTO, writer);
            }
            sw.stop();
            sw.start("Flush Data");
            writer.flush();
            sw.stop();
        } finally {
            writer.close();
            System.out.println(sw.prettyPrint());
        }
    }

    @RequestMapping("/stream")
    public void stream(@RequestParam(required = false) Integer size, HttpServletResponse response) throws IOException {
        StopWatch sw = new StopWatch("Stream Timer");
        sw.start("setting");
        downloadSetting(response);
        ServletOutputStream out = response.getOutputStream();
        BufferedWriter writer = new BufferedWriter(new OutputStreamWriter(out, "GB2312"), 1024);
        sw.stop();
        try {
            sw.start("Query&Write Data");
            streamMapper.streamSelectLimit(Optional.ofNullable(size).orElse(50), resultContext -> {
                StreamDTO one = resultContext.getResultObject();
                writeRow(one, writer);
            });
            sw.stop();
            sw.start("Flush Data");
            writer.flush();
            sw.stop();
        } finally {
            writer.close();
            System.out.println(sw.prettyPrint());
        }
    }

    private void downloadSetting(HttpServletResponse response) {
        response.setContentType("application/csv;charset=gb2312");
        response.setHeader(HttpHeaders.CONTENT_DISPOSITION, "attachment; filename=" + System.currentTimeMillis() + ".csv");
    }

    @SneakyThrows
    private void writeRow(StreamDTO data, BufferedWriter writer) {
        writer.write(data.getId().toString());
        writer.write(CONJ);
        writer.write(data.getName());
        writer.write(CONJ);
        writer.write(data.getValue());
        writer.write('\n');
    }
}

```

@tab StreamMapper.java
``` java
package com.example.exportbitdata;

import org.apache.ibatis.annotations.*;
import org.apache.ibatis.mapping.ResultSetType;
import org.apache.ibatis.session.ResultHandler;
import org.springframework.stereotype.Repository;

import java.util.List;

@Mapper
@Repository
public interface StreamMapper {

    @Select("SELECT * FROM t_stream LIMIT #{size}")
    List<StreamDTO> normalSelectLimit(int size);

    @Options(resultSetType = ResultSetType.FORWARD_ONLY, fetchSize = Integer.MIN_VALUE)
    @ResultType(StreamDTO.class)
    @Select("SELECT * FROM t_stream LIMIT #{size}")
    void streamSelectLimit(@Param("size") int size, ResultHandler<StreamDTO> handler);
}
```

@tab æµ‹è¯•å¯åŠ¨è„šæœ¬
``` bash
# å¯åŠ¨å‘½ä»¤
java -Xmx20m -Xms20m -jar export-bit-data-0.0.1-SNAPSHOT.jar

# è®¿é—®å‘½ä»¤
curl http://localhost:8080/normal?size=5000000  # è¿™ä¸ªç›´æ¥å‡ºç°OOM
curl http://localhost:8080/stream?size=5000000  # è¿™ä¸ªå¯ä»¥ç›´æ¥è¿è¡Œçš„åˆ°ç»“æœ
```

:::

ä»¥ä¸Šå¯ä»¥å¾—å‡ºä¸€ä¸ªç»“è®ºï¼Œæµå¼æŸ¥è¯¢åœ¨è§£å†³ç¼“å­˜å ç”¨æ–¹é¢æœ‰ç€æå¤§çš„ä¼˜åŠ¿ï¼Œå¹¶ä¸”åœ¨æµ‹è¯•å•æ¬¡æŸ¥è¯¢é€Ÿåº¦æ—¶ï¼Œä¼˜åŠ¿ä¹Ÿæ˜¯éå¸¸å¤§çš„ã€‚

æœ¬æ¬¡å·¥ç¨‹æ²¡æœ‰æµ‹è¯•å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„æ‰§è¡Œæ•ˆç‡ï¼Œä»¥åŠåœ¨é«˜å¹¶å‘ç¯å¢ƒä¸‹ï¼Œä¼šä¸ä¼šå‡ºç°åˆ«çš„é—®é¢˜ã€‚

::: warning æ³¨æ„

æµå¼æŸ¥è¯¢æ¯”è¾ƒä¾èµ–CPU

å¯¹æ¯”ä¸€ä¸‹æ™®é€šæŸ¥è¯¢æµç¨‹å’Œæµå¼æŸ¥è¯¢æµç¨‹ï¼š  

```mermaid
---
title: æ™®é€šæŸ¥è¯¢å’Œæµå¼æŸ¥è¯¢
---
flowchart LR
    subgraph æ™®é€šæŸ¥è¯¢
    DB1(æ•°æ®åº“) --> server1(è¯»å–æ•°æ®æ˜¯é˜»å¡çš„, ç›´åˆ°ç½‘ç»œä¼ è¾“å®Œæˆ,CPUå¯ä»¥å¹²åˆ«çš„äº‹å„¿)
    end
    subgraph æµå¼æŸ¥è¯¢
    DB2(æ•°æ®åº“) --> server2(è¯»å–æ•°æ®ä¸é˜»å¡,ä¸€æ¬¡è¯»å–ä¸€æ¡,å¾ªç¯å¤„ç†,å CPU)
    end

```
:::

## å‚è€ƒæ–‡æ¡£
- [MySQLä»¥cursoræ–¹å¼è¯»å–ï¼ˆuseCursorFetchï¼ŒFetchSizeå‚æ•°ï¼‰](https://blog.51cto.com/u_15127595/3391934)
- [å¦‚ä½•é€šè¿‡ MyBatis æŸ¥è¯¢åƒä¸‡æ•°æ®å¹¶ä¿è¯å†…å­˜ä¸æº¢å‡º?](https://zhuanlan.zhihu.com/p/373351899)
- [MySQLå¦‚ä½•æµå¼è¯»å–åƒä¸‡çº§å¤§æ•°æ®](https://zhuanlan.zhihu.com/p/421952313)
- [ç‚¸äº†ï¼ä½¿ç”¨ MyBatis æŸ¥è¯¢åƒä¸‡æ•°æ®é‡ï¼Ÿ](https://zhuanlan.zhihu.com/p/341012871)