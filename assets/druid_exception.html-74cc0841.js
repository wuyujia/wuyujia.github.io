import{_ as r,W as k,X as d,$ as a,a2 as o,Y as n,Z as s,a1 as e,C as p}from"./framework-817d905c.js";const m={},b=e('<h2 id="java-sql-sqlexception-statement-is-closed" tabindex="-1"><a class="header-anchor" href="#java-sql-sqlexception-statement-is-closed" aria-hidden="true">#</a> java.sql.SQLException: statement is closed</h2><h3 id="产生背景" tabindex="-1"><a class="header-anchor" href="#产生背景" aria-hidden="true">#</a> 产生背景</h3><p>这个问题的产生来自于【XH】项目<br> 项目本身为单体项目，采用Tomcat部署，使用数据源Druid版本为<code>1.1.23</code><br> 线上服务正常启动一段时间后，会偶尔出现 <code>java.sql.SQLException: statement is closed</code> 错误<br> 这个错误经过Debug排查来自于以下位置:</p>',3),v=n("div",{class:"language-log line-numbers-mode","data-ext":"log"},[n("pre",{class:"language-log"},[n("code",null,[n("span",{class:"token operator"},"#"),n("span",{class:"token operator"},"#"),n("span",{class:"token operator"},"#"),s(" Cause"),n("span",{class:"token operator"},":"),s(" java"),n("span",{class:"token punctuation"},"."),s("sql"),n("span",{class:"token punctuation"},"."),s("SQLException"),n("span",{class:"token operator"},":"),s(` statement is closed
`),n("span",{class:"token operator"},";"),s(" uncategorized SQLException for SQL "),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token operator"},";"),s(" SQL state "),n("span",{class:"token punctuation"},"["),n("span",{class:"token boolean"},"null"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token operator"},";"),s(" error code "),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token operator"},";"),s(" statement is closed"),n("span",{class:"token operator"},";"),s(" nested exception is "),n("span",{class:"token exception javastacktrace language-javastacktrace"},[s("java"),n("span",{class:"token punctuation"},"."),s("sql"),n("span",{class:"token punctuation"},"."),s("SQLException"),n("span",{class:"token punctuation"},":"),s(` statement is closed
	`),n("span",{class:"token keyword"},"at"),s(" org"),n("span",{class:"token punctuation"},"."),s("springframework"),n("span",{class:"token punctuation"},"."),s("jdbc"),n("span",{class:"token punctuation"},"."),s("support"),n("span",{class:"token punctuation"},"."),s("AbstractFallbackSQLExceptionTranslator"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"translate"),n("span",{class:"token punctuation"},"("),s("AbstractFallbackSQLExceptionTranslator"),n("span",{class:"token punctuation"},"."),s("java"),n("span",{class:"token punctuation"},":"),s("84"),n("span",{class:"token punctuation"},")"),s(`
	`),n("span",{class:"token keyword"},"at"),s(" org"),n("span",{class:"token punctuation"},"."),s("springframework"),n("span",{class:"token punctuation"},"."),s("jdbc"),n("span",{class:"token punctuation"},"."),s("support"),n("span",{class:"token punctuation"},"."),s("AbstractFallbackSQLExceptionTranslator"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"translate"),n("span",{class:"token punctuation"},"("),s("AbstractFallbackSQLExceptionTranslator"),n("span",{class:"token punctuation"},"."),s("java"),n("span",{class:"token punctuation"},":"),s("81"),n("span",{class:"token punctuation"},")"),s(`
	`),n("span",{class:"token keyword"},"at"),s(" org"),n("span",{class:"token punctuation"},"."),s("springframework"),n("span",{class:"token punctuation"},"."),s("jdbc"),n("span",{class:"token punctuation"},"."),s("support"),n("span",{class:"token punctuation"},"."),s("AbstractFallbackSQLExceptionTranslator"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"translate"),n("span",{class:"token punctuation"},"("),s("AbstractFallbackSQLExceptionTranslator"),n("span",{class:"token punctuation"},"."),s("java"),n("span",{class:"token punctuation"},":"),s("81"),n("span",{class:"token punctuation"},")"),s(`
	`),n("span",{class:"token keyword"},"at"),s(" org"),n("span",{class:"token punctuation"},"."),s("mybatis"),n("span",{class:"token punctuation"},"."),s("spring"),n("span",{class:"token punctuation"},"."),s("MyBatisExceptionTranslator"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"translateExceptionIfPossible"),n("span",{class:"token punctuation"},"("),s("MyBatisExceptionTranslator"),n("span",{class:"token punctuation"},"."),s("java"),n("span",{class:"token punctuation"},":"),s("88"),n("span",{class:"token punctuation"},")"),s(`
	`),n("span",{class:"token keyword"},"at"),s(" org"),n("span",{class:"token punctuation"},"."),s("mybatis"),n("span",{class:"token punctuation"},"."),s("spring"),n("span",{class:"token punctuation"},"."),s("SqlSessionTemplate$SqlSessionInterceptor"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"invoke"),n("span",{class:"token punctuation"},"("),s("SqlSessionTemplate"),n("span",{class:"token punctuation"},"."),s("java"),n("span",{class:"token punctuation"},":"),s("440"),n("span",{class:"token punctuation"},")"),s(`
	`),n("span",{class:"token keyword"},"at"),s(" com"),n("span",{class:"token punctuation"},"."),s("sun"),n("span",{class:"token punctuation"},"."),s("proxy"),n("span",{class:"token punctuation"},"."),s("$Proxy83"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"selectList"),n("span",{class:"token punctuation"},"("),s("Unknown Source"),n("span",{class:"token punctuation"},")"),s(`
	`),n("span",{class:"token keyword"},"at"),s(" org"),n("span",{class:"token punctuation"},"."),s("mybatis"),n("span",{class:"token punctuation"},"."),s("spring"),n("span",{class:"token punctuation"},"."),s("SqlSessionTemplate"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"selectList"),n("span",{class:"token punctuation"},"("),s("SqlSessionTemplate"),n("span",{class:"token punctuation"},"."),s("java"),n("span",{class:"token punctuation"},":"),s("223"),n("span",{class:"token punctuation"},")"),s(`
	`),n("span",{class:"token keyword"},"at"),s(" com"),n("span",{class:"token punctuation"},"."),s("baomidou"),n("span",{class:"token punctuation"},"."),s("mybatisplus"),n("span",{class:"token punctuation"},"."),s("core"),n("span",{class:"token punctuation"},"."),s("override"),n("span",{class:"token punctuation"},"."),s("MybatisMapperMethod"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"executeForMany"),n("span",{class:"token punctuation"},"("),s("MybatisMapperMethod"),n("span",{class:"token punctuation"},"."),s("java"),n("span",{class:"token punctuation"},":"),s("173"),n("span",{class:"token punctuation"},")"),s(`
	`),n("span",{class:"token keyword"},"at"),s(" com"),n("span",{class:"token punctuation"},"."),s("baomidou"),n("span",{class:"token punctuation"},"."),s("mybatisplus"),n("span",{class:"token punctuation"},"."),s("core"),n("span",{class:"token punctuation"},"."),s("override"),n("span",{class:"token punctuation"},"."),s("MybatisMapperMethod"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"execute"),n("span",{class:"token punctuation"},"("),s("MybatisMapperMethod"),n("span",{class:"token punctuation"},"."),s("java"),n("span",{class:"token punctuation"},":"),s("78"),n("span",{class:"token punctuation"},")"),s(`
	`),n("span",{class:"token keyword"},"at"),s(" com"),n("span",{class:"token punctuation"},"."),s("baomidou"),n("span",{class:"token punctuation"},"."),s("mybatisplus"),n("span",{class:"token punctuation"},"."),s("core"),n("span",{class:"token punctuation"},"."),s("override"),n("span",{class:"token punctuation"},"."),s("MybatisMapperProxy$PlainMethodInvoker"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"invoke"),n("span",{class:"token punctuation"},"("),s("MybatisMapperProxy"),n("span",{class:"token punctuation"},"."),s("java"),n("span",{class:"token punctuation"},":"),s("148"),n("span",{class:"token punctuation"},")")]),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),y=n("div",{class:"language-java line-numbers-mode","data-ext":"java"},[n("pre",{class:"language-java"},[n("code",null,[n("span",{class:"token punctuation"},"."),n("span",{class:"token punctuation"},"."),n("span",{class:"token punctuation"},"."),s(`
    `),n("span",{class:"token keyword"},"protected"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"checkOpen"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"throws"),s(),n("span",{class:"token class-name"},"SQLException"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("closed"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s("   "),n("span",{class:"token comment"},"// 当statement已经关闭时仍然还在调用就会出现这个问题"),s(`
            `),n("span",{class:"token class-name"},"Throwable"),s(" disableError "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"null"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"this"),n("span",{class:"token punctuation"},"."),s("conn "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token keyword"},"null"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                disableError `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token punctuation"},"."),s("conn"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"getDisableError"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token punctuation"},"}"),s(`

            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("disableError "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token keyword"},"null"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                `),n("span",{class:"token keyword"},"throw"),s(),n("span",{class:"token keyword"},"new"),s(),n("span",{class:"token class-name"},"SQLException"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"statement is closed"'),n("span",{class:"token punctuation"},","),s(" disableError"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
                `),n("span",{class:"token keyword"},"throw"),s(),n("span",{class:"token keyword"},"new"),s(),n("span",{class:"token class-name"},"SQLException"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"statement is closed"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token punctuation"},"}"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"."),n("span",{class:"token punctuation"},"."),n("span",{class:"token punctuation"},"."),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),j=e(`<p>由于项目代码中从没有主动获取Statement并调用close()方法，所以排出项目开发人员的原因，接下来排查方向从框架逻辑入手。</p><p>在 <code>DruidPooledStatement</code> 中可以修改 <code>closed</code> 属性的外部方法仅有 <code>close()</code>，从框架看没有发现明显问题，但是问题产生一定是closed为true</p><p>由于项目重启一切就好了，所以框架代码本身问题应该没有，所以需要再看看配置问题，通过继续排查日志找到如下内容：</p><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code>The last packet successfully received from the server was <span class="token number">71</span><span class="token punctuation">,</span><span class="token number">836</span> milliseconds ago<span class="token punctuation">.</span>  The last packet sent successfully to the server was <span class="token number">8</span><span class="token punctuation">,</span><span class="token number">214</span> milliseconds ago<span class="token punctuation">.</span>
        at sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>NativeConstructorAccessorImpl<span class="token punctuation">.</span>newInstance0<span class="token operator">(</span>Native Method<span class="token operator">)</span> <span class="token operator">~</span><span class="token punctuation">[</span><span class="token operator">?</span><span class="token operator">:</span>1<span class="token punctuation">.</span>8<span class="token punctuation">.</span>0_341<span class="token punctuation">]</span>
        at sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>NativeConstructorAccessorImpl<span class="token punctuation">.</span>newInstance<span class="token operator">(</span>NativeConstructorAccessorImpl<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">62</span><span class="token operator">)</span> <span class="token operator">~</span><span class="token punctuation">[</span><span class="token operator">?</span><span class="token operator">:</span>1<span class="token punctuation">.</span>8<span class="token punctuation">.</span>0_341<span class="token punctuation">]</span>
        at sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>DelegatingConstructorAccessorImpl<span class="token punctuation">.</span>newInstance<span class="token operator">(</span>DelegatingConstructorAccessorImpl<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">45</span><span class="token operator">)</span> <span class="token operator">~</span><span class="token punctuation">[</span><span class="token operator">?</span><span class="token operator">:</span>1<span class="token punctuation">.</span>8<span class="token punctuation">.</span>0_341<span class="token punctuation">]</span>
        at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Constructor<span class="token punctuation">.</span>newInstance<span class="token operator">(</span>Constructor<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">423</span><span class="token operator">)</span> <span class="token operator">~</span><span class="token punctuation">[</span><span class="token operator">?</span><span class="token operator">:</span>1<span class="token punctuation">.</span>8<span class="token punctuation">.</span>0_341<span class="token punctuation">]</span>
        at com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>handleNewInstance<span class="token operator">(</span>Util<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">404</span><span class="token operator">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>mysql<span class="token operator">-</span>connector<span class="token operator">-</span>java<span class="token operator">-</span>5<span class="token punctuation">.</span>1<span class="token punctuation">.</span>39<span class="token punctuation">.</span>jar<span class="token operator">:</span><span class="token number">5.1.39</span><span class="token punctuation">]</span>
        at com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>SQLError<span class="token punctuation">.</span>createCommunicationsException<span class="token operator">(</span>SQLError<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">988</span><span class="token operator">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>mysql<span class="token operator">-</span>connector<span class="token operator">-</span>java<span class="token operator">-</span>5<span class="token punctuation">.</span>1<span class="token punctuation">.</span>39<span class="token punctuation">.</span>jar<span class="token operator">:</span><span class="token number">5.1.39</span><span class="token punctuation">]</span>
        at com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>MysqlIO<span class="token punctuation">.</span>reuseAndReadPacket<span class="token operator">(</span>MysqlIO<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">3552</span><span class="token operator">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>mysql<span class="token operator">-</span>connector<span class="token operator">-</span>java<span class="token operator">-</span>5<span class="token punctuation">.</span>1<span class="token punctuation">.</span>39<span class="token punctuation">.</span>jar<span class="token operator">:</span><span class="token number">5.1.39</span><span class="token punctuation">]</span>
        at com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>MysqlIO<span class="token punctuation">.</span>reuseAndReadPacket<span class="token operator">(</span>MysqlIO<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">3452</span><span class="token operator">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>mysql<span class="token operator">-</span>connector<span class="token operator">-</span>java<span class="token operator">-</span>5<span class="token punctuation">.</span>1<span class="token punctuation">.</span>39<span class="token punctuation">.</span>jar<span class="token operator">:</span><span class="token number">5.1.39</span><span class="token punctuation">]</span>
        at com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>MysqlIO<span class="token punctuation">.</span>checkErrorPacket<span class="token operator">(</span>MysqlIO<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">3893</span><span class="token operator">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>mysql<span class="token operator">-</span>connector<span class="token operator">-</span>java<span class="token operator">-</span>5<span class="token punctuation">.</span>1<span class="token punctuation">.</span>39<span class="token punctuation">.</span>jar<span class="token operator">:</span><span class="token number">5.1.39</span><span class="token punctuation">]</span>
        at com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>MysqlIO<span class="token punctuation">.</span>sendCommand<span class="token operator">(</span>MysqlIO<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">2526</span><span class="token operator">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>mysql<span class="token operator">-</span>connector<span class="token operator">-</span>java<span class="token operator">-</span>5<span class="token punctuation">.</span>1<span class="token punctuation">.</span>39<span class="token punctuation">.</span>jar<span class="token operator">:</span><span class="token number">5.1.39</span><span class="token punctuation">]</span>
        at com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>MysqlIO<span class="token punctuation">.</span>sqlQueryDirect<span class="token operator">(</span>MysqlIO<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">2673</span><span class="token operator">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>mysql<span class="token operator">-</span>connector<span class="token operator">-</span>java<span class="token operator">-</span>5<span class="token punctuation">.</span>1<span class="token punctuation">.</span>39<span class="token punctuation">.</span>jar<span class="token operator">:</span><span class="token number">5.1.39</span><span class="token punctuation">]</span>
        at com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>ConnectionImpl<span class="token punctuation">.</span>execSQL<span class="token operator">(</span>ConnectionImpl<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">2549</span><span class="token operator">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>mysql<span class="token operator">-</span>connector<span class="token operator">-</span>java<span class="token operator">-</span>5<span class="token punctuation">.</span>1<span class="token punctuation">.</span>39<span class="token punctuation">.</span>jar<span class="token operator">:</span><span class="token number">5.1.39</span><span class="token punctuation">]</span>
        at com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>PreparedStatement<span class="token punctuation">.</span>executeInternal<span class="token operator">(</span>PreparedStatement<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1861</span><span class="token operator">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>mysql<span class="token operator">-</span>connector<span class="token operator">-</span>java<span class="token operator">-</span>5<span class="token punctuation">.</span>1<span class="token punctuation">.</span>39<span class="token punctuation">.</span>jar<span class="token operator">:</span><span class="token number">5.1.39</span><span class="token punctuation">]</span>
        at com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>PreparedStatement<span class="token punctuation">.</span>execute<span class="token operator">(</span>PreparedStatement<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1192</span><span class="token operator">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>mysql<span class="token operator">-</span>connector<span class="token operator">-</span>java<span class="token operator">-</span>5<span class="token punctuation">.</span>1<span class="token punctuation">.</span>39<span class="token punctuation">.</span>jar<span class="token operator">:</span><span class="token number">5.1.39</span><span class="token punctuation">]</span>
        at com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>druid<span class="token punctuation">.</span>filter<span class="token punctuation">.</span>FilterChainImpl<span class="token punctuation">.</span>preparedStatement_execute<span class="token operator">(</span>FilterChainImpl<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">3461</span><span class="token operator">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>druid<span class="token operator">-</span>1<span class="token punctuation">.</span>1<span class="token punctuation">.</span>23<span class="token punctuation">.</span>jar<span class="token operator">:</span><span class="token number">1.1.23</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个问题通常来说就是Druid数据源中的连接被认为还是有效的，但是MySQL服务端实际上已经把这个连接给干掉了，所以才会出现这个问题。经过排查，确认了以下信息：</p><ul><li>mysql服务端连接超时时间：3600 s，<code>show global variables like &#39;wait_timeout&#39;;</code></li><li>java应用配置检测项: <ul><li>testOnReturn：false // 这个没开，但凡这个开了，这个问题发生现象都会没有，但是，生产环境一般不开，为啥捏～，因为性能问题，开了之后高并发就GG了</li><li>testOnBorrow：false</li><li>testWhileIdle：true</li><li>timeBetweenEvictionRunsMillis：3600000 // 1小时，问题来了，检测周期1小时监测1次，过期也是1小时，那么就可能遇到问题，现在只需要调低这个值，就能轻松解决问题</li></ul></li></ul><p>怀疑就是连接失效导致出现了 <code>statement is closed</code></p><h3 id="解决方法" tabindex="-1"><a class="header-anchor" href="#解决方法" aria-hidden="true">#</a> 解决方法:</h3><p>timeBetweenEvictionRunsMillis=600000 // 改成10分钟检查一次空闲链接是否有效，这样多半不会出问题了</p><h2 id="查阅资料" tabindex="-1"><a class="header-anchor" href="#查阅资料" aria-hidden="true">#</a> 查阅资料</h2>`,10),h={href:"https://github.com/search?q=is%3Aissue%20Druid%20statement%20is%20closed&type=issues",target:"_blank",rel:"noopener noreferrer"},g={href:"https://blog.csdn.net/lifetragedy/article/details/116641291",target:"_blank",rel:"noopener noreferrer"};function w(x,f){const c=p("Tabs"),t=p("ExternalLinkIcon");return k(),d("div",null,[b,a(c,{id:"9",data:[{title:"ErrorMessage"},{title:"com/alibaba/druid/pool/DruidPooledStatement.java"}],active:1},{tab0:o(({title:l,value:u,isActive:i})=>[v]),tab1:o(({title:l,value:u,isActive:i})=>[y]),_:1},8,["data"]),j,n("ul",null,[n("li",null,[n("a",h,[s("activeCount大于maxActive"),a(t)])]),n("li",null,[n("a",g,[s("彻底解决jdbc数据库连接超时重试-communication link failure的正确姿势"),a(t)])])])])}const S=r(m,[["render",w],["__file","druid_exception.html.vue"]]);export{S as default};
